name: CI

on:
    pull_request: ~
    push: ~

jobs:
    ecs:
        name: ECS
        runs-on: ubuntu-latest
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
        steps:
            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.1 # Run with the lowest supported to avoid incompatible fixes
                    extensions: dom, fileinfo, filter, gd, hash, intl, json, mbstring, mysqli, pcre, pdo_mysql, zlib
                    coverage: none
                env:
                    COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Install the dependencies
                run: |
                    composer install --no-interaction --no-progress
                    composer bin ecs install --no-interaction --no-progress

            -   name: Run ECS
                run: tools/ecs/vendor/bin/ecs check src tests --config ecs.php --no-progress-bar --ansi

    phpstan:
        name: PHPStan
        runs-on: ubuntu-latest
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
        steps:
            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.1
                    extensions: dom, fileinfo, filter, gd, hash, intl, json, mbstring, mysqli, pcre, pdo_mysql, zlib
                    coverage: none
                env:
                    COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Install the dependencies
                run: |
                    composer install --no-interaction --no-progress
                    composer bin phpstan install --no-interaction --no-progress

            -   name: Run PHPStan
                run: tools/phpstan/vendor/bin/phpstan analyse --no-progress

    tests:
        name: PHP ${{ matrix.php }}
        runs-on: ubuntu-latest
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
        strategy:
            fail-fast: false
            matrix:
                php: [ 8.1, 8.2 ]
        steps:
            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    extensions: dom, fileinfo, filter, gd, hash, intl, json, mbstring, mysqli, pcre, pdo_mysql, zlib
                    coverage: none
                env:
                    COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Install the dependencies
                run: composer install --no-interaction --no-progress

            -   name: Run the unit tests
                run: vendor/bin/phpunit --colors=always

    nightly:
        name: PHP 8.1
        runs-on: ubuntu-latest
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
        continue-on-error: true
        steps:
            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.1
                    extensions: dom, fileinfo, filter, gd, hash, intl, json, mbstring, mysqli, pcre, pdo_mysql, zlib
                    coverage: none
                env:
                    COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Install the dependencies
                run: composer install --ignore-platform-req=php --no-interaction --no-progress

            -   name: Run the unit tests
                run: vendor/bin/phpunit --colors=always
